/* =========================================================
   ZipZapZoi Universal Auth System — auth.js
   ---------------------------------------------------------
   Handles: 
   ✅ Global Nav Auth UI
   ✅ Login persistence across pages
   ✅ User personalization
   ✅ Role detection (admin / user)
   ✅ Auth-required actions
   ✅ Seamless logout.js integration
   ========================================================= */

(function(){
  const STORAGE_KEY = "zzz_user";
  const navArea = document.getElementById("navAuthArea");

  /* ---------------- Helper Functions ---------------- */

  // Get user safely from session/local storage
  function getUser(){
    try {
      return JSON.parse(sessionStorage.getItem(STORAGE_KEY) || localStorage.getItem(STORAGE_KEY) || "null");
    } catch(e){
      console.warn("Auth parse error", e);
      return null;
    }
  }

  // Save user to both storages
  function setUser(user){
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(user));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
  }

  // Logout helper (used by logout.js as well)
  function logoutUser(){
    sessionStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_KEY);
    // Try toast if available, otherwise reload
    if(window.ZipZapLogout && typeof window.ZipZapLogout.logout === "function"){
      window.ZipZapLogout.logout();
    } else {
      window.location.href = "Login Page.html";
    }
  }

  // Require login before performing actions (e.g. post ad)
  window.requireLogin = function(action){
    const user = getUser();
    if(!user){
      alert("Please log in or sign up to continue.");
      location.href = "Login Page.html";
      return false;
    }
    return true;
  };

  /* ---------------- Nav Rendering ---------------- */

  if(navArea){
    const user = getUser();

    if(user){
      const name = user.email ? user.email.split('@')[0] : "User";
      const initial = user.email ? user.email.charAt(0).toUpperCase() : "U";

      navArea.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full flex items-center justify-center bg-primary/10 text-primary font-bold uppercase shadow">
            ${initial}
          </div>
          <div class="flex flex-col leading-tight">
            <p class="font-semibold text-dark-charcoal dark:text-white">${name}</p>
            <button id="logoutBtn" class="text-sm text-red-500 font-medium hover:underline">Logout</button>
          </div>
        </div>
      `;

      // Wire logout immediately
      const btn = document.getElementById("logoutBtn");
      if(btn) btn.addEventListener("click", logoutUser);

      // Personalize greetings or titles if present
      const welcomeTitle = document.getElementById("welcomeTitle") || document.getElementById("welcomeText");
      if(welcomeTitle) welcomeTitle.textContent = `Welcome back, ${name}!`;

    } else {
      // Not logged in
      navArea.innerHTML = `
        <div class="flex items-center gap-3">
          <a href="Login Page.html" class="text-sm font-semibold text-dark-charcoal dark:text-white hover:text-primary transition-colors">Log In</a>
          <a href="User Registration.html"
            class="px-4 py-2 bg-primary text-white rounded-full font-bold text-sm shadow hover:-translate-y-0.5 hover:shadow-bouncy-lg transition-all">
            Sign Up
          </a>
        </div>
      `;

      const welcomeTitle = document.getElementById("welcomeTitle") || document.getElementById("welcomeText");
      if(welcomeTitle) welcomeTitle.textContent = "Welcome to ZipZapZoi!";
    }
  }

  /* ---------------- Auto-Persistence ---------------- */
  // Restore sessionStorage from localStorage if missing
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved && !sessionStorage.getItem(STORAGE_KEY)){
    sessionStorage.setItem(STORAGE_KEY, saved);
  }

  /* ---------------- Export Helpers Globally ---------------- */
  window.ZipZapAuth = { getUser, setUser, logoutUser };
})();
