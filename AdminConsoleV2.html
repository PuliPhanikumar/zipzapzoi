<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  // --- ADMIN SECURITY CHECK ---
  (function() {
    const raw = localStorage.getItem('zzz_user');
    if (raw) {
      const user = JSON.parse(raw);
      if (user.role === 'user') { // Simple check: if explicit user role, deny.
        alert("Access Denied: Admin privileges required.");
        window.location.href = 'classifieds.html';
      }
    }
  })();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Console V2 - ZipZapZoi</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Spline Sans", "sans-serif"] },
          colors: {
            "primary": "#019863",
            "secondary": "#4D96A9",
            "secondary-yellow": "#FFD700",
            "secondary-coral": "#FF6F61",
          },
          boxShadow: {
            "bouncy": "0px 10px 20px -5px rgba(0, 0, 0, 0.1), 0px 4px 6px -2px rgba(0, 0, 0, 0.05)",
          }
        }
      }
    }
  </script>

  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    body { font-family: 'Spline Sans', sans-serif; }
    
    /* Layout & Scrollbars */
    .sidebar { background: #1a2332; }
    .sidebar a { color: #9ca3af; transition: all 0.3s; }
    .sidebar a.active { color: #10b981; background: rgba(16,185,129,0.1); }
    .sidebar a:hover { color: #10b981; }
    
    .section-content { display: none; }
    .section-content.active { display: block; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Live Data Animations */
    .data-value { transition: color 0.3s ease, transform 0.2s ease; }
    .flash-up { color: #16a34a !important; transform: scale(1.1); }
    .flash-down { color: #dc2626 !important; transform: scale(1.1); }
    
    /* Toggle Switches */
    .toggle-wrapper { position: relative; display: inline-flex; align-items: center; cursor: pointer; width: 44px; height: 24px; }
    .toggle-input { position: absolute; opacity: 0; width: 0; height: 0; }
    .toggle-track { width: 100%; height: 100%; background: #e5e7eb; border-radius: 9999px; transition: 0.2s; }
    .toggle-knob { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .toggle-input:checked + .toggle-track { background: #019863; }
    .toggle-input:checked + .toggle-track .toggle-knob { transform: translateX(20px); }

    /* Custom Field Cards */
    .field-card { transition: transform 0.1s; }
    .field-card:hover { transform: translateX(3px); }
  </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden flex text-gray-800">

  <aside class="sidebar w-64 text-white p-6 flex-shrink-0 flex flex-col h-full shadow-xl z-20">
    <div class="mb-8 flex items-center gap-3">
      <div class="w-8 h-8 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center text-white font-bold">Z</div>
      <div>
        <h1 class="text-xl font-bold text-white tracking-tight">ZipZapZoi</h1>
        <p class="text-xs text-gray-400">Admin Console V2</p>
      </div>
    </div>

    <nav class="space-y-1 flex-1 overflow-y-auto">
      <a href="#" class="nav-link active block px-3 py-2.5 rounded-lg flex items-center gap-3" data-section="dashboard">
        <span class="material-symbols-outlined">analytics</span> Reports & Analytics
      </a>
      <a href="#" class="nav-link block px-3 py-2.5 rounded-lg flex items-center gap-3" data-section="categories">
        <span class="material-symbols-outlined">category</span> Category Manager
      </a>
      <a href="#" class="nav-link block px-3 py-2.5 rounded-lg flex items-center gap-3" data-section="users">
        <span class="material-symbols-outlined">group</span> User Management
      </a>
      <a href="#" class="nav-link block px-3 py-2.5 rounded-lg flex items-center gap-3" data-section="roles">
        <span class="material-symbols-outlined">admin_panel_settings</span> Roles & Permissions
      </a>
      <a href="#" class="nav-link block px-3 py-2.5 rounded-lg flex items-center gap-3" data-section="listings">
        <span class="material-symbols-outlined">inventory_2</span> Listings
      </a>
      <a href="#" class="nav-link block px-3 py-2.5 rounded-lg flex items-center gap-3" data-section="alerts">
        <span class="material-symbols-outlined">notifications_active</span> Custom Alerts
      </a>
    </nav>

    <div class="mt-auto pt-6 border-t border-gray-700 space-y-2">
      <button onclick="resetDefaults()" class="w-full px-4 py-2 rounded-lg bg-yellow-600/20 text-yellow-400 hover:bg-yellow-600/30 text-sm flex items-center gap-2 transition-colors">
        <span class="material-symbols-outlined text-sm">restart_alt</span> Reset Schema
      </button>
      <button onclick="handleLogout()" class="w-full px-4 py-2 rounded-lg text-red-400 hover:bg-red-900/20 text-sm flex items-center gap-2 transition-colors">
        <span class="material-symbols-outlined text-sm">logout</span> Logout
      </button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full overflow-hidden relative">
    
    <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between flex-shrink-0 z-10">
      <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Reports & Analytics</h1>
      <div class="flex items-center gap-4">
        <button id="globalSaveBtn" onclick="saveAndPublish()" class="hidden bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-transform active:scale-95">
           <span class="material-symbols-outlined text-lg">save</span> Save Changes
        </button>
        
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">A</div>
          <div class="text-sm">
            <p class="font-bold text-gray-800 leading-none">Super Admin</p>
            <p class="text-xs text-gray-500">Access: All</p>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8 bg-gray-50 scroll-smooth" id="mainScrollArea">

      <section id="dashboard" class="section-content active">
        <div class="flex justify-between items-center mb-8">
          <div>
            <div class="flex items-center gap-3">
              <h2 class="text-2xl font-bold text-gray-800">Live Overview</h2>
              <span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-bold flex items-center gap-1">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                Live
              </span>
            </div>
            <p class="text-gray-500 text-sm">Real-time system performance and user activity.</p>
          </div>
          <button onclick="document.getElementById('customizeModal').showModal()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 shadow-sm transition-all">
            <span class="material-symbols-outlined text-lg">tune</span> Customize
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="metricsGrid">
          <div class="bg-white p-6 rounded-xl shadow-bouncy border border-gray-100 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-6xl text-primary">payments</span></div>
            <p class="text-gray-500 text-sm font-medium">Total Revenue</p>
            <p id="metric-revenue" class="data-value text-3xl font-bold text-gray-800 mt-1">$15,489</p>
            <p class="text-green-500 text-xs font-bold mt-2 flex items-center gap-1"><span class="material-symbols-outlined text-sm">trending_up</span> +8.3% this week</p>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-bouncy border border-gray-100 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-6xl text-secondary-yellow">group</span></div>
            <p class="text-gray-500 text-sm font-medium">Active Users</p>
            <p id="metric-users" class="data-value text-3xl font-bold text-gray-800 mt-1">1,251</p>
            <p class="text-green-500 text-xs font-bold mt-2 flex items-center gap-1"><span class="material-symbols-outlined text-sm">trending_up</span> +3.8% today</p>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-bouncy border border-gray-100 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-6xl text-blue-500">inventory_2</span></div>
            <p class="text-gray-500 text-sm font-medium">New Listings</p>
            <p id="metric-listings" class="data-value text-3xl font-bold text-gray-800 mt-1">317</p>
            <p class="text-green-500 text-xs font-bold mt-2 flex items-center gap-1"><span class="material-symbols-outlined text-sm">trending_up</span> +12% last hour</p>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-bouncy border border-gray-100 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-6xl text-red-500">flag</span></div>
            <p class="text-gray-500 text-sm font-medium">Flagged Items</p>
            <p id="metric-flags" class="data-value text-3xl font-bold text-gray-800 mt-1">45</p>
            <p class="text-red-500 text-xs font-bold mt-2 flex items-center gap-1"><span class="material-symbols-outlined text-sm">warning</span> Action Required</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div id="chart-revenue-container" class="bg-white p-6 rounded-xl shadow-bouncy border border-gray-100">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">Revenue Trend</h3>
              <button class="text-gray-400 hover:text-primary"><span class="material-symbols-outlined">more_horiz</span></button>
            </div>
            <div class="h-64 w-full">
              <canvas id="chartRevenue"></canvas>
            </div>
          </div>

          <div id="chart-users-container" class="bg-white p-6 rounded-xl shadow-bouncy border border-gray-100">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">User Activity</h3>
              <button class="text-gray-400 hover:text-primary"><span class="material-symbols-outlined">more_horiz</span></button>
            </div>
            <div class="h-64 w-full">
              <canvas id="chartUsers"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="categories" class="section-content">
        <div class="flex justify-between items-end mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Dynamic Schema Manager</h2>
            <p class="text-sm text-gray-500">Structure your marketplace categories and fields.</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[600px]">
          <div class="lg:col-span-3 flex flex-col bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden h-full">
            <div class="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
              <span class="text-xs font-bold uppercase text-gray-500 tracking-wider">Categories</span>
              <button onclick="document.getElementById('catModal').showModal(); catForm.reset();" class="p-1 hover:bg-blue-100 text-blue-600 rounded"><span class="material-symbols-outlined text-lg">add</span></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="categoriesList"></div>
          </div>

          <div class="lg:col-span-4 flex flex-col bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden h-full">
            <div class="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
              <span class="text-xs font-bold uppercase text-gray-500 tracking-wider" id="subHeader">Subcategories</span>
              <button id="btnAddSub" onclick="addSubcategory()" disabled class="p-1 hover:bg-green-100 text-green-600 rounded disabled:opacity-50"><span class="material-symbols-outlined text-lg">add</span></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="subcategoriesList">
               <div class="h-full flex items-center justify-center text-gray-400 text-sm">Select a Category</div>
            </div>
          </div>

          <div class="lg:col-span-5 flex flex-col bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden h-full">
            <div class="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
              <span class="text-xs font-bold uppercase text-gray-500 tracking-wider" id="fieldHeader">Form Fields</span>
              <button id="btnAddField" onclick="addField()" disabled class="p-1 hover:bg-purple-100 text-purple-600 rounded disabled:opacity-50"><span class="material-symbols-outlined text-lg">add</span></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50/50" id="fieldsList">
               <div class="h-full flex items-center justify-center text-gray-400 text-sm">Select a Subcategory</div>
            </div>
          </div>
        </div>
      </section>

      <section id="users" class="section-content">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Internal Users</h2>
            <p class="text-sm text-gray-500">Manage Moderators, Support Agents, and Admins.</p>
          </div>
          <button onclick="openCreateUserModal()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg font-bold shadow-bouncy hover:bg-green-700 transition-all">
            <span class="material-symbols-outlined">person_add</span> Create New Admin
          </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <table class="w-full text-left">
            <thead class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold">
              <tr>
                <th class="px-6 py-4">User</th>
                <th class="px-6 py-4">Role</th>
                <th class="px-6 py-4">Status</th>
                <th class="px-6 py-4">Actions</th>
              </tr>
            </thead>
            <tbody id="adminUsersList" class="divide-y divide-gray-100 text-sm text-gray-700">
              </tbody>
          </table>
        </div>
      </section>

      <section id="roles" class="section-content">
        <div class="flex justify-between items-center mb-8">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Roles & Permissions</h2>
            <p class="text-sm text-gray-500">Define what each administrator type can access.</p>
          </div>
          <button onclick="document.getElementById('roleModal').showModal(); document.getElementById('roleForm').reset();" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg font-bold shadow-bouncy hover:bg-green-700 transition-all">
            <span class="material-symbols-outlined">add_circle</span> Create New Role
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
          <div class="md:col-span-1 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <h3 class="p-4 bg-gray-50 border-b border-gray-100 font-bold text-gray-700">Roles</h3>
            <div class="p-2 space-y-1" id="roleList"></div>
          </div>
          <div class="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
              <h3 class="text-xl font-bold text-gray-800" id="selectedRoleName">Super Admin</h3>
              <button id="deleteRoleBtn" onclick="deleteRole()" class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors hidden"><span class="material-symbols-outlined">delete</span> Delete Role</button>
            </div>
            <div id="permissionsContainer" class="space-y-4"></div>
          </div>
        </div>
      </section>

      <section id="alerts" class="section-content">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">System Alerts</h2>
          <button class="bg-primary text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow hover:bg-green-700 transition-colors">
            <span class="material-symbols-outlined">add_alert</span> New Alert
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center"><span class="material-symbols-outlined">flag</span></div>
              <div>
                <h3 class="font-bold text-gray-800">Flagged Content</h3>
                <p class="text-sm text-gray-500">Notify me when a listing receives > 3 reports</p>
              </div>
            </div>
            <label class="toggle-wrapper">
              <input type="checkbox" class="toggle-input" id="alert-flagged" onchange="toggleAlert('flagged', this.checked)">
              <div class="toggle-track"><div class="toggle-knob"></div></div>
            </label>
          </div>

          <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center"><span class="material-symbols-outlined">person_off</span></div>
              <div>
                <h3 class="font-bold text-gray-800">Suspicious Activity</h3>
                <p class="text-sm text-gray-500">Alert on multiple failed login attempts</p>
              </div>
            </div>
            <label class="toggle-wrapper">
              <input type="checkbox" class="toggle-input" id="alert-suspicious" onchange="toggleAlert('suspicious', this.checked)">
              <div class="toggle-track"><div class="toggle-knob"></div></div>
            </label>
          </div>

          <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center"><span class="material-symbols-outlined">payments</span></div>
              <div>
                <h3 class="font-bold text-gray-800">High Value Transactions</h3>
                <p class="text-sm text-gray-500">Notify when transaction > $1000</p>
              </div>
            </div>
            <label class="toggle-wrapper">
              <input type="checkbox" class="toggle-input" id="alert-payments" onchange="toggleAlert('payments', this.checked)">
              <div class="toggle-track"><div class="toggle-knob"></div></div>
            </label>
          </div>
        </div>
      </section>

      <section id="settings" class="section-content">
        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
          <h2 class="text-xl font-bold mb-4">Admin Settings</h2>
          <p class="text-gray-500">Configure platform variables, API keys, and admin permissions.</p>
        </div>
      </section>

    </div>
  </main>

  <dialog id="customizeModal" class="p-0 rounded-xl shadow-2xl w-full max-w-lg backdrop:bg-black/50">
    <div class="p-6 bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Customize Dashboard</h3>
        <button onclick="document.getElementById('customizeModal').close()" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="space-y-4">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="font-medium">Show Revenue Chart</span>
          <label class="toggle-wrapper"><input type="checkbox" id="toggle-revenue-chart" onchange="toggleWidget('chart-revenue-container', this.checked)" checked class="toggle-input"><div class="toggle-track"><div class="toggle-knob"></div></div></label>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="font-medium">Show User Activity</span>
          <label class="toggle-wrapper"><input type="checkbox" id="toggle-users-chart" onchange="toggleWidget('chart-users-container', this.checked)" checked class="toggle-input"><div class="toggle-track"><div class="toggle-knob"></div></div></label>
        </div>
      </div>
      <div class="mt-6 flex justify-end">
        <button onclick="document.getElementById('customizeModal').close()" class="bg-primary text-white px-4 py-2 rounded-lg font-bold">Done</button>
      </div>
    </div>
  </dialog>

  <dialog id="userModal" class="p-0 rounded-xl shadow-2xl w-full max-w-md backdrop:bg-black/50">
    <div class="p-6 bg-white">
      <h3 class="text-xl font-bold mb-4 text-gray-800">Create New Admin User</h3>
      <form id="createUserForm" class="space-y-4">
        <div><label class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="newUserName" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary" required></div>
        <div><label class="block text-sm font-medium mb-1">Email Address</label><input type="email" id="newUserEmail" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary" required></div>
        <div><label class="block text-sm font-medium mb-1">Assign Role</label><select id="newUserRole" class="w-full border rounded-lg px-3 py-2 bg-white outline-none focus:ring-2 focus:ring-primary"></select></div>
        <div id="tempPassContainer" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
           <p class="text-xs text-green-700 font-bold mb-1">✅ User Created! Copy credentials:</p>
           <div class="flex justify-between items-center bg-white border border-green-200 rounded px-2 py-1"><code id="tempPassDisplay" class="text-sm font-mono text-gray-800">pass123</code><button type="button" onclick="copyPass()" class="text-xs text-green-600 hover:underline">Copy</button></div>
        </div>
        <div class="flex justify-end gap-2 pt-4 border-t"><button type="button" onclick="document.getElementById('userModal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Close</button><button type="submit" id="createUsrBtn" class="bg-primary text-white px-4 py-2 rounded-lg font-bold">Create & Generate Password</button></div>
      </form>
    </div>
  </dialog>

  <dialog id="roleModal" class="p-0 rounded-xl shadow-2xl w-full max-w-md backdrop:bg-black/50">
    <div class="p-6 bg-white">
      <h3 class="text-xl font-bold mb-4">Create New Role</h3>
      <form id="roleForm" class="space-y-4">
        <div><label class="block text-sm font-medium mb-1">Role Name</label><input type="text" id="roleNameInput" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary" required></div>
        <div class="flex justify-end gap-2 pt-4"><button type="button" onclick="document.getElementById('roleModal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button><button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg font-bold">Create Role</button></div>
      </form>
    </div>
  </dialog>

  <dialog id="catModal" class="p-0 rounded-xl shadow-2xl w-full max-w-md backdrop:bg-black/50">
    <div class="p-6 bg-white">
      <h3 class="text-xl font-bold mb-4">Add Category</h3>
      <form id="catForm" class="space-y-4">
        <div><label class="block text-sm font-medium mb-1">Name</label><input type="text" id="catName" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary" required></div>
        <div><label class="block text-sm font-medium mb-1">Icon</label><input type="text" id="catIcon" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary" placeholder="e.g. devices"></div>
        <div><label class="block text-sm font-medium mb-1">Color</label><select id="catColor" class="w-full border rounded-lg px-3 py-2 bg-white"><option value="text-cyan-500">Cyan</option><option value="text-blue-600">Blue</option><option value="text-green-600">Green</option></select></div>
        <div class="flex justify-end gap-2 pt-4"><button type="button" onclick="document.getElementById('catModal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button><button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg font-bold">Save</button></div>
      </form>
    </div>
  </dialog>

<script>
// ==========================================
// 1. REPORT & ANALYTICS LOGIC (Charts + Metrics)
// ==========================================
const metrics = { revenue: 15489, users: 1251, listings: 317, flags: 45 };
let revenueChart, usersChart;

function initCharts() {
  const ctxRev = document.getElementById('chartRevenue')?.getContext('2d');
  const ctxUser = document.getElementById('chartUsers')?.getContext('2d');
  
  if(ctxRev && ctxUser) {
    if(revenueChart) revenueChart.destroy();
    if(usersChart) usersChart.destroy();

    revenueChart = new Chart(ctxRev, {
      type: 'line',
      data: {
        labels: ['10:00', '10:05', '10:10', '10:15', '10:20', '10:25'],
        datasets: [{ label: 'Revenue', data: [15000, 15200, 15100, 15350, 15400, 15489], borderColor: '#019863', tension: 0.4, fill: false }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    usersChart = new Chart(ctxUser, {
      type: 'bar',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
        datasets: [{ label: 'Users', data: [1000, 1100, 1050, 1200, 1150, 1251], backgroundColor: '#4D96A9' }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  }
}

function updateMetrics() {
  // Simulate Random Shifts
  metrics.revenue += Math.floor(Math.random() * 200 - 50);
  metrics.users += Math.floor(Math.random() * 10 - 2);
  metrics.listings += Math.floor(Math.random() * 5 - 1);
  
  // Update DOM
  updateVal('metric-revenue', '$' + metrics.revenue.toLocaleString());
  updateVal('metric-users', metrics.users.toLocaleString());
  updateVal('metric-listings', metrics.listings.toLocaleString());
  
  // Update Charts
  if(revenueChart) {
    revenueChart.data.datasets[0].data.push(metrics.revenue);
    if(revenueChart.data.datasets[0].data.length > 10) revenueChart.data.datasets[0].data.shift();
    revenueChart.update('none');
  }
}

function updateVal(id, val) {
  const el = document.getElementById(id);
  if(el) {
    el.textContent = val;
    el.classList.add('flash-up');
    setTimeout(()=> el.classList.remove('flash-up'), 500);
  }
}

setInterval(updateMetrics, 3000); // 3-sec interval

// Toggle Logic for Customize Modal
window.toggleWidget = (id, show) => {
  const el = document.getElementById(id);
  if(el) el.style.display = show ? 'block' : 'none';
}

// Alert Toggles Logic (Persist)
window.toggleAlert = (key, val) => {
  localStorage.setItem('zzz_alert_'+key, val);
}
// Load Alerts State
['flagged','suspicious','payments'].forEach(k => {
  const el = document.getElementById('alert-'+k);
  if(el) el.checked = localStorage.getItem('zzz_alert_'+k) === 'true';
});


// ==========================================
// 2. USER MANAGEMENT LOGIC
// ==========================================
function loadAdminUsers() {
  const users = JSON.parse(localStorage.getItem('zzz_users') || '[]');
  const list = document.getElementById('adminUsersList');
  if(!list) return;

  const admins = users.filter(u => u.role !== 'user');
  if(admins.length === 0) {
    list.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No admin users found. Create one!</td></tr>`;
    return;
  }

  list.innerHTML = admins.map(u => `
    <tr>
      <td class="px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold uppercase">${u.name.charAt(0)}</div>
          <div><p class="font-bold text-gray-800">${u.name}</p><p class="text-xs text-gray-500">${u.email}</p></div>
        </div>
      </td>
      <td class="px-6 py-4"><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-bold uppercase">${rolesData[u.role]?.label || u.role}</span></td>
      <td class="px-6 py-4"><span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Active</span></td>
      <td class="px-6 py-4"><button class="text-gray-400 hover:text-red-500" onclick="deleteUser('${u.id}')"><span class="material-symbols-outlined text-lg">delete</span></button></td>
    </tr>
  `).join('');
}

function openCreateUserModal() {
  const modal = document.getElementById('userModal');
  document.getElementById('createUserForm').reset();
  document.getElementById('tempPassContainer').classList.add('hidden');
  document.getElementById('createUsrBtn').classList.remove('hidden');
  const select = document.getElementById('newUserRole');
  select.innerHTML = Object.keys(rolesData).map(k => `<option value="${k}">${rolesData[k].label}</option>`).join('');
  modal.showModal();
}

document.getElementById('createUserForm').onsubmit = (e) => {
  e.preventDefault();
  const name = document.getElementById('newUserName').value;
  const email = document.getElementById('newUserEmail').value;
  const role = document.getElementById('newUserRole').value;
  const tempPass = "ZipZap" + Math.floor(Math.random() * 9000 + 1000);
  
  const newUser = { id: 'adm_'+Date.now(), name: name, email: email, password: tempPass, role: role, status: 'active', avatar: '' };
  const users = JSON.parse(localStorage.getItem('zzz_users') || '[]');
  
  if(users.some(u => u.email === email)) { alert("Email exists!"); return; }
  users.push(newUser);
  localStorage.setItem('zzz_users', JSON.stringify(users));
  
  document.getElementById('tempPassDisplay').textContent = tempPass;
  document.getElementById('tempPassContainer').classList.remove('hidden');
  document.getElementById('createUsrBtn').classList.add('hidden');
  loadAdminUsers();
};

window.copyPass = () => { navigator.clipboard.writeText(document.getElementById('tempPassDisplay').textContent); alert("Copied!"); };
window.deleteUser = (id) => { if(confirm("Delete User?")) { let users = JSON.parse(localStorage.getItem('zzz_users')||'[]'); users = users.filter(u=>u.id!==id); localStorage.setItem('zzz_users',JSON.stringify(users)); loadAdminUsers(); } };


// ==========================================
// 3. ROLES & PERMISSIONS LOGIC
// ==========================================
const ROLES_KEY = 'zzz_admin_roles';
let rolesData = {
  'super_admin': { label: 'Super Admin', isSystem: true, permissions: { 'view_dashboard': true, 'manage_users': true, 'manage_roles': true, 'delete_content': true, 'manage_schema': true } },
  'moderator': { label: 'Moderator', isSystem: true, permissions: { 'view_dashboard': true, 'delete_content': true, 'approve_listings': true } },
  'support': { label: 'Support Agent', isSystem: true, permissions: { 'view_dashboard': true, 'manage_users': true } }
};
let currentRole = 'super_admin';

function loadRoles() {
  const saved = localStorage.getItem(ROLES_KEY);
  if (saved) rolesData = JSON.parse(saved);
  renderRoles();
}

function renderRoles() {
  const list = document.getElementById('roleList');
  if(!list) return;
  list.innerHTML = Object.keys(rolesData).map(key => `
    <div onclick="selectRole('${key}')" class="flex items-center justify-between p-3 rounded-lg cursor-pointer ${key===currentRole ? 'bg-primary/10 border-l-4 border-primary' : 'hover:bg-gray-50 border-l-4 border-transparent'}">
      <span class="font-bold text-sm ${key===currentRole?'text-primary':'text-gray-700'}">${rolesData[key].label}</span>
      <span class="material-symbols-outlined text-gray-400 text-sm">chevron_right</span>
    </div>
  `).join('');
  renderPermissions();
}

function selectRole(key) { currentRole = key; renderRoles(); }

function renderPermissions() {
  const container = document.getElementById('permissionsContainer');
  document.getElementById('selectedRoleName').textContent = rolesData[currentRole].label;
  const delBtn = document.getElementById('deleteRoleBtn');
  if(rolesData[currentRole].isSystem) delBtn.classList.add('hidden'); else delBtn.classList.remove('hidden');

  const perms = [
    { k:'view_dashboard', l:'View Dashboard', d:'Access analytics' },
    { k:'manage_users', l:'Manage Users', d:'Suspend/Ban users' },
    { k:'manage_roles', l:'Manage Roles', d:'Edit permissions' },
    { k:'manage_schema', l:'Category Manager', d:'Edit categories/fields' },
    { k:'approve_listings', l:'Approve Listings', d:'Moderation queue' },
    { k:'delete_content', l:'Delete Content', d:'Remove listings' }
  ];

  container.innerHTML = perms.map(p => `
    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
      <div><p class="font-bold text-sm">${p.l}</p><p class="text-xs text-gray-500">${p.d}</p></div>
      <label class="toggle-wrapper"><input type="checkbox" class="toggle-input" ${rolesData[currentRole].permissions[p.k]?'checked':''} onchange="togglePerm('${p.k}', this.checked)"><div class="toggle-track"><div class="toggle-knob"></div></div></label>
    </div>
  `).join('');
}

window.togglePerm = (perm, val) => { rolesData[currentRole].permissions[perm] = val; localStorage.setItem(ROLES_KEY, JSON.stringify(rolesData)); };
document.getElementById('roleForm').onsubmit = (e) => { e.preventDefault(); const name = document.getElementById('roleNameInput').value; const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_'); rolesData[id] = { label: name, isSystem: false, permissions: {'view_dashboard': true} }; localStorage.setItem(ROLES_KEY, JSON.stringify(rolesData)); currentRole = id; renderRoles(); document.getElementById('roleModal').close(); };
window.deleteRole = () => { if(confirm("Delete Role?")) { delete rolesData[currentRole]; localStorage.setItem(ROLES_KEY, JSON.stringify(rolesData)); currentRole = 'super_admin'; renderRoles(); } };


// ==========================================
// 4. SCHEMA MANAGER LOGIC (Categories)
// ==========================================
const STORAGE_KEY = 'zzz_classifieds_schema';
const DEFAULT_SCHEMA = {
    categories: [{ id: 'electronics', label: 'Electronics', icon: 'devices', color: 'text-cyan-500' }],
    subcategories: [{ id: 'mobiles', categoryId: 'electronics', label: 'Mobiles' }],
    fields: [{ id: 'brand', subcategoryId: 'mobiles', label: 'Brand', type: 'text', required: true }]
};
let schema = JSON.parse(JSON.stringify(DEFAULT_SCHEMA));
let catState = { selCat: null, selSub: null };

function loadSchema() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) { try { schema = JSON.parse(saved); if(!schema.fields) schema.fields=[]; } catch(e) { console.error(e); } } else { saveSchema(); }
    renderCatAll();
}
function saveSchema() { localStorage.setItem(STORAGE_KEY, JSON.stringify(schema)); }
function saveAndPublish() { saveSchema(); const btn = document.getElementById('globalSaveBtn'); const t = btn.innerHTML; btn.innerHTML = "Saved!"; setTimeout(()=>btn.innerHTML=t, 1500); }
function resetDefaults() { if(confirm("Reset Schema?")) { schema=JSON.parse(JSON.stringify(DEFAULT_SCHEMA)); saveAndPublish(); renderCatAll(); } }

function renderCatAll() {
    const cl = document.getElementById('categoriesList');
    if(cl) cl.innerHTML = schema.categories.map(c => `<div onclick="selCat('${c.id}')" class="p-2 cursor-pointer hover:bg-gray-50 flex justify-between ${catState.selCat===c.id?'bg-blue-50':''}"><span>${c.label}</span><button onclick="delCat('${c.id}', event)" class="text-red-300 hover:text-red-500">×</button></div>`).join('');
    
    const sl = document.getElementById('subcategoriesList');
    if(catState.selCat) {
       const subs = schema.subcategories.filter(s => s.categoryId === catState.selCat);
       sl.innerHTML = subs.map(s => `<div onclick="selSub('${s.id}')" class="p-2 cursor-pointer hover:bg-gray-50 flex justify-between ${catState.selSub===s.id?'bg-green-50':''}"><span>${s.label}</span><button onclick="delSub('${s.id}', event)" class="text-red-300 hover:text-red-500">×</button></div>`).join('');
       document.getElementById('btnAddSub').disabled = false;
    } else { sl.innerHTML='<div class="text-center text-gray-400 mt-10">Select Category</div>'; document.getElementById('btnAddSub').disabled = true; }

    const fl = document.getElementById('fieldsList');
    if(catState.selSub) {
       const flds = schema.fields.filter(f => f.subcategoryId === catState.selSub);
       fl.innerHTML = flds.map(f => `<div class="p-2 border mb-1 rounded bg-white flex justify-between"><div><b>${f.label}</b> <span class="text-xs text-gray-500">(${f.type})</span></div><button onclick="delField('${f.id}')" class="text-red-300 hover:text-red-500">×</button></div>`).join('');
       document.getElementById('btnAddField').disabled = false;
    } else { fl.innerHTML='<div class="text-center text-gray-400 mt-10">Select Subcategory</div>'; document.getElementById('btnAddField').disabled = true; }
}

function selCat(id) { catState.selCat = id; catState.selSub = null; renderCatAll(); }
function selSub(id) { catState.selSub = id; renderCatAll(); }
function addSubcategory() { const n = prompt("Subcategory Name:"); if(n) { schema.subcategories.push({ id:'sub_'+Date.now(), categoryId:catState.selCat, label:n }); saveSchema(); renderCatAll(); } }
function addField() { const n = prompt("Field Label:"); if(n) { schema.fields.push({ id:'f_'+Date.now(), subcategoryId:catState.selSub, label:n, type:'text', required:false }); saveSchema(); renderCatAll(); } }
window.delCat = (id,e) => { e.stopPropagation(); if(confirm("Delete?")) { schema.categories = schema.categories.filter(c=>c.id!==id); saveSchema(); catState.selCat=null; renderCatAll(); } };
window.delSub = (id,e) => { e.stopPropagation(); if(confirm("Delete?")) { schema.subcategories = schema.subcategories.filter(s=>s.id!==id); saveSchema(); catState.selSub=null; renderCatAll(); } };
window.delField = (id) => { if(confirm("Delete?")) { schema.fields = schema.fields.filter(f=>f.id!==id); saveSchema(); renderCatAll(); } };
document.getElementById('catForm').onsubmit = (e) => { e.preventDefault(); const l = document.getElementById('catName').value; const id = l.toLowerCase().replace(/[^a-z]/g, '-'); schema.categories.push({ id, label:l, icon:document.getElementById('catIcon').value, color:document.getElementById('catColor').value }); saveSchema(); renderCatAll(); document.getElementById('catModal').close(); };


// ==========================================
// 5. GLOBAL NAVIGATION
// ==========================================
document.querySelectorAll('.nav-link').forEach(link => {
  link.onclick = (e) => {
    e.preventDefault();
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
    document.getElementById(link.dataset.section).classList.add('active');
    
    // Toggle Save Button
    const saveBtn = document.getElementById('globalSaveBtn');
    if(saveBtn) link.dataset.section === 'categories' ? saveBtn.classList.remove('hidden') : saveBtn.classList.add('hidden');
    
    // Refresh Logic
    if(link.dataset.section === 'users') loadAdminUsers();
    if(link.dataset.section === 'dashboard') initCharts();
  }
});

function handleLogout() {
  if(confirm("Log out?")) {
    localStorage.removeItem('zzz_user');
    window.location.href = 'classifieds.html';
  }
}

// STARTUP
loadRoles();
loadAdminUsers();
loadSchema();
setTimeout(initCharts, 500);

</script>
</body>
</html>