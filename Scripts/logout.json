/* logout.js â€” robust global logout */
(function () {
  const LOGIN_PAGE = 'Login Page.html';
  const KEYS_TO_CLEAR = ['zzz_user', 'zzz_users', 'zzz_users_v1'];

  function clearAuthStorage() {
    try {
      KEYS_TO_CLEAR.forEach(k => sessionStorage.removeItem(k));
      KEYS_TO_CLEAR.forEach(k => localStorage.removeItem(k));
    } catch (err) {
      console.warn('logout: storage clear error', err);
    }
  }

  function doLogout(e) {
    if (e && e.preventDefault) e.preventDefault();
    clearAuthStorage();
    // Remove any page-level auto-redirect tasks
    try { window.stop && window.stop(); } catch(e){}
    try {
      window.location.replace(LOGIN_PAGE);
    } catch (err) {
      window.location.href = LOGIN_PAGE;
    }
  }

  function attachTo(el) {
    if (!el || el.__zzz_logout_wired) return;
    el.addEventListener('click', doLogout);
    el.__zzz_logout_wired = true;
  }

  function wireExisting() {
    document.querySelectorAll('#logoutBtn, #sidebarLogout, [data-action="logout"], .logout, button[data-logout]').forEach(attachTo);
  }

  // Observe DOM for nav injection or later-created logout controls
  const mo = new MutationObserver(() => {
    if (document.querySelector('#logoutBtn, #sidebarLogout, [data-action="logout"], .logout, button[data-logout]')) {
      wireExisting();
    }
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { wireExisting(); mo.observe(document.documentElement || document.body, { childList:true, subtree:true }); });
  } else {
    wireExisting(); mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
  }

  // Export programmatic API
  window.ZipZapLogout = { logout: doLogout, clearStorage: clearAuthStorage };
})();
