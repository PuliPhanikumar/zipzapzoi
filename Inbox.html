<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>ZipZapZoi - Messages</title>
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#007BFF',
            secondary: '#48C9B0',
            'background-light': '#F7F8FC',
            'background-dark': '#1A1C23',
            'component-light': '#FFFFFF',
            'component-dark': '#242731',
            'text-light': '#333333',
            'text-dark': '#E0E0E0',
            'text-muted-light': '#6b7280',
            'text-muted-dark': '#9ca3af',
            'accent-yellow': '#FFC107',
            'accent-coral': '#FF7F50'
          },
          fontFamily: {
            display: 'Spline Sans, sans-serif'
          },
          borderRadius: {
            DEFAULT: '1rem',
            lg: '1.5rem',
            xl: '2rem',
            full: '9999px'
          },
          boxShadow: {
            bouncy: '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05), inset 0 -2px 3px rgba(0, 0, 0, 0.04)',
            'bouncy-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07), inset 0 -4px 6px rgba(0, 0, 0, 0.05)',
            'bouncy-inner': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.05)',
            'primary': '0 4px 14px 0 rgba(0, 123, 255, 0.39)'
          }
        }
      }
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      vertical-align: middle;
    }
  </style>
  <script src="js/data-manager.js"></script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
  <script>
    // Set current user FIRST - BEFORE anything else âœ…
    if (!localStorage.getItem('currentUser')) {
      localStorage.setItem('currentUser', JSON.stringify({ id: 'user2', name: 'You' }));
    }
  </script>

  <div class="flex h-screen w-full p-4 lg:p-6">
    <div class="grid w-full h-full grid-cols-12 gap-4 lg:gap-6">
      <!-- Left Column Navigation Sidebar -->
      <aside class="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-4 lg:gap-6">
        <!-- SideNavBar -->
        <div class="bg-component-light dark:bg-component-dark p-4 rounded-lg shadow-bouncy flex-shrink-0">
          <div class="flex flex-col justify-between h-full">
            <div class="flex flex-col gap-4">
              <div class="flex items-center gap-3">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" style="background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCUI9NB-4S_PuEF1yrhKkHgU8BGbh2G4wgNVssjvBM2pP916rFfPvMN-g-f826XKtOCzCLrZp1FcWdhTWG20FeVOVOAKYCsQgvcLqroDgD79Lfim3Kr4Pmn7szmlZsa5r98lD_ahALTRldYl7HhpA4WON9oeqZ_py274xUHJhOiYW6Sc9MdjswinPMNdt3BUshmrt1XukhWJVheJnvAMGm9MdCKuMDCnsk3KOmrfzRW6zyR3Oa9mtmcrYcbelxLon0AjRQjIwJaCUW3);"></div>
                <div class="flex flex-col">
                  <h1 class="text-text-light dark:text-text-dark text-base font-semibold">John Doe</h1>
                  <p class="text-text-muted-light dark:text-text-muted-dark text-sm font-normal">My Account</p>
                </div>
              </div>
              <div class="flex flex-col gap-1 mt-4">
                <a class="flex items-center gap-4 px-4 py-2.5 rounded-full text-text-muted-light dark:text-text-muted-dark hover:bg-primary/10 hover:text-primary transition-all" href="#">
                  <span class="material-symbols-outlined">home</span>
                  <p class="text-sm font-medium">Home</p>
                </a>
                <a class="flex items-center gap-4 px-4 py-2.5 rounded-full text-text-muted-light dark:text-text-muted-dark hover:bg-primary/10 hover:text-primary transition-all" href="#">
                  <span class="material-symbols-outlined">search</span>
                  <p class="text-sm font-medium">Browse</p>
                </a>
                <a class="flex items-center gap-4 px-4 py-2.5 rounded-full bg-primary/10 text-primary transition-all font-semibold" href="#">
                  <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1">inbox</span>
                  <p class="text-sm font-medium">Messages</p>
                </a>
                <a class="flex items-center gap-4 px-4 py-2.5 rounded-full text-text-muted-light dark:text-text-muted-dark hover:bg-primary/10 hover:text-primary transition-all" href="#">
                  <span class="material-symbols-outlined">favorite</span>
                  <p class="text-sm font-medium">Favorites</p>
                </a>
                <a class="flex items-center gap-4 px-4 py-2.5 rounded-full text-text-muted-light dark:text-text-muted-dark hover:bg-primary/10 hover:text-primary transition-all" href="#">
                  <span class="material-symbols-outlined">person</span>
                  <p class="text-sm font-medium">Profile</p>
                </a>
              </div>
            </div>
            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-4 bg-accent-yellow text-text-light text-sm font-bold mt-6 shadow-md hover:scale-105 active:scale-95 transition-transform duration-150">
              <span class="truncate">Create Listing</span>
            </button>
          </div>
        </div>

        <!-- Inbox List -->
        <div class="bg-component-light dark:bg-component-dark p-4 rounded-lg shadow-bouncy flex flex-col gap-4 flex-grow min-h-0">
          <div class="flex flex-wrap justify-between items-center gap-3">
            <p class="text-text-light dark:text-text-dark text-2xl font-bold leading-tight">Messages</p>
          </div>

          <!-- SearchBar -->
          <div class="flex-shrink-0">
            <label class="flex flex-col w-full">
              <div class="flex w-full flex-1 items-stretch rounded-full h-12 bg-background-light dark:bg-background-dark shadow-bouncy-inner">
                <div class="text-text-muted-light dark:text-text-muted-dark flex items-center justify-center pl-4">
                  <span class="material-symbols-outlined">search</span>
                </div>
                <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-text-light dark:text-text-dark focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark px-2 text-base font-normal" placeholder="Search conversations..." value="">
              </div>
            </label>
          </div>

          <!-- Message Thread List -->
          <div class="flex flex-col gap-2 overflow-y-auto pr-2 -mr-2" id="conversationList">
            <!-- Conversations will be rendered here by JavaScript -->
          </div>
        </div>
      </aside>

      <!-- Right Column Conversation View -->
      <main class="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-4 lg:gap-6 min-h-0">
        <div class="bg-component-light dark:bg-component-dark rounded-lg shadow-bouncy-lg flex-grow flex flex-col">
          <!-- Conversation Header -->
          <header class="sticky top-0 z-10 flex items-center justify-between p-4 border-b border-background-light dark:border-background-dark flex-shrink-0">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" style="background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCm-1SeavDVqzibcHztOCxP7QKQdyokJGUB7hzdsXNGWl_nyvIbjsV3blxorkxGY5NnXGqcKT0IFkVIyDMFGeHm-Kx0Ts8YsgXI3FYNxFlRuplr9oGwbgGE9-_bL9ckLZfBGOVCxI2ojEYvWmKuf9Zf_g2sWA-jLESerHe74x2CdJniRID0Di05krQVbQ0Twp38eFgedT1gUOEtP-1QoPpY0CrMP7WappoaK0-7eh-rubqy6gVWV3c9f0E2NRkxbiuIEWayd0dki97H);"></div>
                <div class="absolute bottom-0 right-0 size-3 rounded-full bg-green-500 border-2 border-component-light dark:border-component-dark"></div>
              </div>
              <div>
                <h2 class="text-lg font-bold text-text-light dark:text-text-dark">Jane Smith</h2>
                <p class="text-sm text-green-500">Online</p>
              </div>
            </div>
            <button class="p-2 rounded-full hover:bg-background-light dark:hover:bg-background-dark text-text-muted-light dark:text-text-muted-dark">
              <span class="material-symbols-outlined">more_horiz</span>
            </button>
          </header>

          <!-- Associated Listing Banner -->
          <div class="p-4 border-b border-background-light dark:border-background-dark flex-shrink-0">
            <a class="flex items-center gap-4 p-3 rounded-lg bg-background-light dark:bg-background-dark hover:shadow-bouncy transition-shadow" href="#">
              <div class="bg-center bg-no-repeat aspect-video bg-cover rounded w-24" style="background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCCO7d_IQtO4saCrA0Rn5aLhu-pC6lLwgfRwkqpMVtaVwsNpR2_jxK-YTflTuVTepGIXehKjjRugEKNiQZD3CqSDz5SsNhfp-gB6mwBfeHCfHLEI7nge3e4fSidseaAd6QoIu430vhZ8o4e2HqI2WEgz-VDUrlVtZOcOUZGqCCwGsT-8-DRFrmhUkhrJoqqYjyo93f87RsBUVCZMALCQeE5uO6h2NzV2DSIzZFUlXq4CYBJbFkaYWxohp8b1w6mJLzyViBZoSHpOhSd);"></div>
              <div class="flex-grow">
                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Conversation about:</p>
                <h3 class="font-semibold text-text-light dark:text-text-dark">Vintage Leather Jacket</h3>
              </div>
              <p class="text-lg font-bold text-primary">$120</p>
            </a>
          </div>

          <!-- Message History -->
          <div class="flex-grow p-6 overflow-y-auto space-y-6" id="messagesContainer">
            <!-- Messages will be rendered here by JavaScript -->
          </div>

          <!-- Message Input Field -->
          <div class="p-4 border-t border-background-light dark:border-background-dark flex-shrink-0">
            <div class="flex items-center gap-4 bg-background-light dark:bg-background-dark rounded-full h-14 p-2 shadow-bouncy-inner">
              <button class="p-2 rounded-full hover:bg-primary/10 text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
                <span class="material-symbols-outlined">add_photo_alternate</span>
              </button>
              <button class="p-2 rounded-full hover:bg-primary/10 text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
                <span class="material-symbols-outlined">attach_file</span>
              </button>
              <input id="messageInput" class="flex-grow bg-transparent border-none focus:ring-0 text-text-light dark:text-text-dark placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark" placeholder="Type your message..." type="text">
              <button id="sendBtn" class="flex items-center justify-center size-10 rounded-full bg-primary text-white shadow-primary hover:scale-105 active:scale-95 transition-transform duration-150">
                <span class="material-symbols-outlined">send</span>
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // âœ… CORRECTED INBOX SCRIPT
    
    // DOM refs using IDs directly
    const convListEl = document.getElementById('conversationList');
    const convHeaderName = document.querySelector('header h2');
    const convHeaderStatus = document.querySelector('header p');
    const messagesContainer = document.getElementById('messagesContainer');
    const inputEl = document.querySelector('input[placeholder="Type your message..."]');

    // Store setup
    // CORRECT - Initialize store FIRST, then load messages
const KEY = 'zzzinboxdatav1';
let store = JSON.parse(sessionStorage.getItem(KEY)) || null;
if (!store) {
  store = { conversations: [], selectedId: null };
}

// NOW call loadMessagesFromLocalStorage
loadMessagesFromLocalStorage(); // âœ… store exists now!

// Load messages from localStorage - FIXED âœ…
function loadMessagesFromLocalStorage() {
  const zzz_messages = JSON.parse(localStorage.getItem('zzz_messages') || '[]');
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{"id":"user2"}');
  
  console.log('ðŸ“¥ Found', zzz_messages.length, 'messages in localStorage');
  console.log('ðŸ‘¤ Current user:', currentUser);
  
  if (zzz_messages.length === 0) {
    console.log('âš ï¸ No messages in localStorage yet');
    return;
  }

  const conversationMap = {};
  
  zzz_messages.forEach(msg => {
    const fromName = msg.fromName || 'User ' + msg.fromUserId;
    const key = `${msg.fromUserId}_${msg.listingId}_${fromName}`;
    
    if (!conversationMap[key]) {
      conversationMap[key] = {
        id: 'conv_' + key,
        name: fromName,
        avatar: '',
        online: false,
        unread: 0,
        listing: {
          id: msg.listingId,
          title: msg.listingTitle || 'Listing',
          price: 0,
          url: '#'
        },
        messages: []
      };
    } else {
      // Always update name to the latest senderName
      conversationMap[key].name = fromName;
    }
    
    conversationMap[key].messages.push({
      id: msg.id,
      from: msg.fromUserId === currentUser.id ? 'me' : 'them',
      text: msg.text,
      at: msg.timestamp
    });
    
    if (msg.toUserId === currentUser.id && !msg.read) {
      conversationMap[key].unread += 1;
    }
  });

  const newConversations = Object.values(conversationMap);
  store.conversations = [
    ...store.conversations.filter(c => !newConversations.find(nc => nc.id === c.id)),
    ...newConversations
  ];
  
  console.log('âœ… Total conversations:', store.conversations.length);
  save();
}

    // Utilities
    function save() {
      sessionStorage.setItem(KEY, JSON.stringify(store));
    }

    function timeAgo(ts) {
      const diff = Math.floor((Date.now() - ts) / 60000);
      if (diff < 1) return 'Now';
      if (diff < 60) return diff + 'm';
      if (diff < 1440) return Math.floor(diff / 60) + 'h';
      return Math.floor(diff / 1440) + 'd';
    }

    // Render conversation list
    function renderList() {
      if (!convListEl) return;
      convListEl.innerHTML = '';
      
      if (store.conversations.length === 0) {
        convListEl.innerHTML = '<p class="text-center text-text-muted-light py-4">No messages yet</p>';
        return;
      }
      
      store.conversations.forEach(conv => {
        const item = document.createElement('div');
        item.className = 'flex gap-4 p-3 justify-between rounded-lg hover:bg-background-light dark:hover:bg-background-dark cursor-pointer transition-all';
        if (store.selectedId === conv.id) item.classList.add('bg-primary/10');
        
        const lastMsg = conv.messages[conv.messages.length - 1];
        item.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" style="background-image: url('${conv.avatar||'https://via.placeholder.com/64'}')"></div>
            <div class="flex flex-col">
              <p class="text-base font-medium">${conv.name}</p>
              <p class="text-primary text-sm font-medium truncate max-w-40">${lastMsg?.text || 'No messages'}</p>
            </div>
          </div>
          <div class="shrink-0 flex flex-col items-end gap-1">
            <p class="text-text-muted-light text-xs">${lastMsg ? timeAgo(new Date(lastMsg.at).getTime()) : ''}</p>
            ${conv.unread > 0 ? `<div class="flex size-6 items-center justify-center rounded-full bg-primary text-white text-xs font-bold">${conv.unread}</div>` : ''}
          </div>
        `;
        item.addEventListener('click', () => selectConversation(conv.id));
        convListEl.appendChild(item);
      });
    }

    // Render selected conversation
    function renderConversation(id) {
      const conv = store.conversations.find(c => c.id === id);
      if (!conv) return;

      if (convHeaderName) convHeaderName.textContent = conv.name;
      if (convHeaderStatus) convHeaderStatus.textContent = conv.online ? 'Online' : 'Offline';

      if (messagesContainer) {
        messagesContainer.innerHTML = '';
        conv.messages.forEach(m => {
          const side = m.from === 'me' ? 'justify-end' : 'justify-start';
          const bubbleBg = m.from === 'me' ? 'bg-primary text-white' : 'bg-gray-200 darkbg-gray-600 text-text-light darktext-text-dark';
          const pWrap = document.createElement('div');
          pWrap.className = `flex ${side}`;
          pWrap.innerHTML = `
            <div class="max-w-md">
              <div class="p-4 rounded-lg ${m.from === 'me' ? 'rounded-br-none' : 'rounded-bl-none'} ${bubbleBg} shadow-bouncy">
                <p>${m.text}</p>
              </div>
              <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1 ${m.from === 'me' ? 'text-right mr-1' : 'ml-1'}">${new Date(m.at).toLocaleTimeString()}</p>
            </div>
          `;
          messagesContainer.appendChild(pWrap);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      conv.unread = 0;
      save();
      renderList();
    }

    function selectConversation(id) {
      store.selectedId = id;
      save();
      renderConversation(id);
      renderList();
    }

    // Load and render
    loadMessagesFromLocalStorage();
    renderList();
    if (store.conversations.length > 0 && !store.selectedId) {
      store.selectedId = store.conversations[0].id;
      renderConversation(store.selectedId);
    }

    // Refresh when page gains focus
    window.addEventListener('focus', loadMessagesFromLocalStorage);
    // ============================================
    // SEND MESSAGE FUNCTION âœ…
    // ============================================
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('messageInput');

    function sendReply() {
      const text = msgInput.value.trim();
      
      if (!text) {
        alert('âš ï¸ Please type a message');
        return;
      }

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{"id":"user2"}');
      const conv = store.conversations.find(c => c.id === store.selectedId);
      
      if (!conv) {
        alert('âŒ Select a conversation first');
        return;
      }

      // Add message to conversation
      const newMsg = {
        id: 'msg_' + Date.now(),
        from: 'me',
        text: text,
        at: new Date().toISOString()
      };

      conv.messages.push(newMsg);

      // Also save to localStorage
      const zzz_messages = JSON.parse(localStorage.getItem('zzz_messages') || '[]');
      zzz_messages.push({
        id: newMsg.id,
        fromUserId: currentUser.id,
        toUserId: 'seller',
        listingId: conv.listing.id,
        listingTitle: conv.listing.title,
        text: text,
        timestamp: newMsg.at,
        read: false
      });
      localStorage.setItem('zzz_messages', JSON.stringify(zzz_messages));

      // Clear input
      msgInput.value = '';

      // Refresh UI
      save();
      renderConversation(conv.id);
      renderList();

      console.log('âœ… Message sent!');
    }

    // Attach send button click
    if (sendBtn) {
      sendBtn.addEventListener('click', sendReply);
    }

    // Also allow Enter key to send
    if (msgInput) {
      msgInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendReply();
        }
      });
    }

    // Expose for debugging
    window._zzz_inbox = { store, save, sendReply };
  </script>
  <script src="scripts/auth.js"></script>
  <script src="scripts/boot.js"></script>
</body>
</html>
