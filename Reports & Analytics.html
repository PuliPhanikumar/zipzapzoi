<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZipZapZoi â€” Reports & Analytics (Live Admin)</title>

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#007BFF",
            "secondary-yellow": "#FFD700",
            "secondary-coral": "#FF6F61",
            "text-light": "#333333",
            "text-dark": "#F4F6F8",
            "background-light": "#F4F6F8",
            "background-dark": "#121212",
            "card-light": "#FFFFFF",
            "card-dark": "#1E1E1E",
            "border-light": "#E0E0E0",
            "border-dark": "#2D2D2D"
          },
          fontFamily: { display: ["Spline Sans", "sans-serif"] },
          borderRadius: { "DEFAULT": "0.75rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px" },
          boxShadow: {
            "bouncy": "0px 10px 20px -5px rgba(0, 123, 255, 0.15), 0px 4px 6px -2px rgba(0, 123, 255, 0.1)",
            "bouncy-hover": "0px 15px 25px -5px rgba(0, 123, 255, 0.2), 0px 8px 10px -4px rgba(0, 123, 255, 0.15)"
          }
        }
      }
    };
  </script>

  <style>
    .material-symbols-outlined {
      font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      font-size: 24px;
    }
    .data-value {
      transition: color 0.3s ease-in-out, transform 0.25s ease-in-out;
    }
    .flash-up {
      color: #16a34a !important;
      transform: scale(1.06);
    }
    .flash-down {
      color: #dc2626 !important;
      transform: scale(1.06);
    }
    /* ensure canvases are responsive */
    canvas { width: 100% !important; height: 240px !important; }
  </style>
  <script src="js/data-manager.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark"
      data-protected="true" data-role="admin">

  <!-- Nav auto-loaded by boot.js -->

  <main class="flex-1 p-8 max-w-7xl mx-auto">
    <div class="flex flex-wrap justify-between gap-4 items-center mb-8">
      <div class="flex flex-col gap-1">
        <div class="flex items-center gap-3">
          <p class="text-4xl font-bold tracking-tight text-text-light dark:text-text-dark">Reports & Analytics</p>
          <div class="flex items-center gap-2 rounded-full bg-green-100 dark:bg-green-900/50 px-3 py-1 text-sm font-medium text-green-700 dark:text-green-300">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            <span>Live</span>
          </div>
        </div>
        <p class="text-gray-500 dark:text-gray-400 text-base">Real-time performance and data insights.</p>
      </div>
      <button id="btnCustomize" class="flex items-center gap-2 px-6 py-3 text-white bg-primary rounded-full font-semibold shadow-bouncy hover:shadow-bouncy-hover transition-transform hover:-translate-y-0.5">
        <span class="material-symbols-outlined">edit</span> Customize
      </button>
    </div>

    <!-- Metric Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="metric-card rounded-xl p-6 bg-card-light dark:bg-card-dark shadow-bouncy hover:shadow-bouncy-hover transition">
        <p class="text-base font-medium">Revenue (Live)</p>
        <p id="metric-revenue" class="data-value text-4xl font-bold mt-2">$15,489</p>
        <p id="metric-revenue-sub" class="text-green-500 text-sm font-medium mt-1">+8.3% vs last month</p>
      </div>

      <div class="metric-card rounded-xl p-6 bg-card-light dark:bg-card-dark shadow-bouncy hover:shadow-bouncy-hover transition">
        <p class="text-base font-medium">Active Users</p>
        <p id="metric-users" class="data-value text-4xl font-bold mt-2">1,251</p>
        <p id="metric-users-sub" class="text-green-500 text-sm font-medium mt-1">+3.8% vs yesterday</p>
      </div>

      <div class="metric-card rounded-xl p-6 bg-card-light dark:bg-card-dark shadow-bouncy hover:shadow-bouncy-hover transition">
        <p class="text-base font-medium">New Listings</p>
        <p id="metric-listings" class="data-value text-4xl font-bold mt-2">317</p>
        <p id="metric-listings-sub" class="text-green-500 text-sm font-medium mt-1">+6.7% vs last hour</p>
      </div>

      <div class="metric-card rounded-xl p-6 bg-card-light dark:bg-card-dark shadow-bouncy hover:shadow-bouncy-hover transition">
        <p class="text-base font-medium">Flagged Items</p>
        <p id="metric-flags" class="data-value text-4xl font-bold mt-2">45</p>
        <p id="metric-flags-sub" class="text-red-500 text-sm font-medium mt-1">-3% vs yesterday</p>
      </div>
    </div>

    <!-- Charts Area -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-bouncy p-6">
        <h2 class="text-2xl font-bold mb-2">Revenue Trend (Recent)</h2>
        <canvas id="chartRevenue"></canvas>
      </div>

      <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-bouncy p-6">
        <h2 class="text-2xl font-bold mb-2">Active Users (Recent)</h2>
        <canvas id="chartUsers"></canvas>
      </div>
    </div>
  </main>

  <!-- Boot Loader (loads nav + auth + logout + protection) -->
  <script src="scripts/boot.js"></script>

  <!-- Live Metrics + Charts -->
  <script>
    /****************************************************************
     * Live Metrics + Charts
     *
     * How it works:
     *  - By default USE_API = false (simulation). Set true to call API.
     *  - If USE_API true, updateMetrics() will try to fetch /api/admin/metrics.
     *    The request includes an Authorization header if zzz_user.token exists.
     *  - On each refresh we update metric cards and charts, with a small flash animation.
     ****************************************************************/

    // ---------- CONFIG ----------
    const USE_API = false; // set true to call backend /api/admin/metrics
    const METRICS_ENDPOINT = "/api/admin/metrics"; // change to full URL if needed
    const REFRESH_MS = 4000;

    // ---------- Local state ----------
    const metrics = {
      revenue: 15489,
      users: 1251,
      listings: 317,
      flags: 45
    };

    // ---------- Helpers ----------
    function formatCurrency(n){
      return '$' + Number(n).toLocaleString();
    }
    function formatNumber(n){
      return Number(n).toLocaleString();
    }

    function flashElement(el, upOrDown){
      if(!el) return;
      el.classList.remove('flash-up', 'flash-down');
      void el.offsetWidth; // reflow to restart animation
      el.classList.add(upOrDown === 'up' ? 'flash-up' : 'flash-down');
      setTimeout(()=> el.classList.remove('flash-up', 'flash-down'), 600);
    }

    function animateValueTo(elId, newValue, type = 'number'){
      const el = document.getElementById(elId);
      if(!el) return;
      const raw = el.textContent.replace(/[^0-9.-]/g,'');
      const oldValue = raw === '' ? 0 : Number(raw);
      const diff = newValue - oldValue;
      // update text
      el.textContent = (type === 'currency') ? formatCurrency(newValue) : formatNumber(newValue);
      flashElement(el, diff >= 0 ? 'up' : 'down');
    }

    // ---------- Chart Setup ----------
    const revenueCtx = document.getElementById('chartRevenue').getContext('2d');
    const usersCtx = document.getElementById('chartUsers').getContext('2d');

    // initial labels: last N ticks
    const HISTORY_LENGTH = 10;
    const initialLabels = Array.from({length: HISTORY_LENGTH}, (_, i) => {
      const d = new Date(Date.now() - (HISTORY_LENGTH - i) * REFRESH_MS);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    });

    const revenueData = {
      labels: initialLabels.slice(),
      datasets: [{
        label: 'Revenue',
        data: Array(HISTORY_LENGTH).fill(metrics.revenue),
        borderColor: '#007BFF',
        backgroundColor: 'rgba(0,123,255,0.08)',
        tension: 0.35,
        pointRadius: 2,
        pointBackgroundColor: '#007BFF'
      }]
    };

    const usersData = {
      labels: initialLabels.slice(),
      datasets: [{
        label: 'Active Users',
        data: Array(HISTORY_LENGTH).fill(metrics.users),
        backgroundColor: 'rgba(255,215,0,0.6)',
        borderColor: '#FFD700',
      }]
    };

    const revenueChart = new Chart(revenueCtx, {
      type: 'line',
      data: revenueData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true },
          y: { beginAtZero: false }
        }
      }
    });

    const usersChart = new Chart(usersCtx, {
      type: 'bar',
      data: usersData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true },
          y: { beginAtZero: true }
        }
      }
    });

    // ---------- Fetch real metrics (if enabled) ----------
    async function fetchMetricsFromApi(){
      try {
        const rawUser = sessionStorage.getItem('zzz_user') || localStorage.getItem('zzz_user') || null;
        let token = null;
        if(rawUser){
          try {
            const parsed = JSON.parse(rawUser);
            token = parsed && parsed.token ? parsed.token : null;
          } catch(e){}
        }
        const headers = { 'Accept': 'application/json' };
        if(token) headers['Authorization'] = 'Bearer ' + token;

        const res = await fetch(METRICS_ENDPOINT, { method: 'GET', headers });
        if(!res.ok) throw new Error('API response ' + res.status);
        const data = await res.json();
        // Expecting shape: { revenue: number, users: number, listings: number, flags: number, meta?: {...} }
        return {
          revenue: Number(data.revenue || metrics.revenue),
          users: Number(data.users || metrics.users),
          listings: Number(data.listings || metrics.listings),
          flags: Number(data.flags || metrics.flags),
          raw: data
        };
      } catch (err) {
        console.warn('Metrics API failed:', err);
        return null;
      }
    }

    // ---------- Update pipeline ----------
    async function updateMetricsAndCharts(){
      // 1) Attempt API if enabled
      let apiData = null;
      if(USE_API){
        apiData = await fetchMetricsFromApi();
      }

      if(apiData){
        // adopt API values
        metrics.revenue = apiData.revenue;
        metrics.users = apiData.users;
        metrics.listings = apiData.listings;
        metrics.flags = apiData.flags;
      } else {
        // Simulation fallback (small random walk)
        metrics.revenue += Math.floor(Math.random() * 500 - 250);
        metrics.users += Math.floor(Math.random() * 30 - 15);
        metrics.listings += Math.floor(Math.random() * 15 - 7);
        metrics.flags += Math.floor(Math.random() * 5 - 2);

        metrics.revenue = Math.max(10000, metrics.revenue);
        metrics.users = Math.max(100, metrics.users);
        metrics.listings = Math.max(0, metrics.listings);
        metrics.flags = Math.max(0, metrics.flags);
      }

      // 2) Update metric cards
      animateValueTo('metric-revenue', metrics.revenue, 'currency');
      animateValueTo('metric-users', metrics.users, 'number');
      animateValueTo('metric-listings', metrics.listings, 'number');
      animateValueTo('metric-flags', metrics.flags, 'number');

      // 3) Update charts (push latest values)
      const nowLabel = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      // revenue chart
      revenueData.labels.push(nowLabel);
      revenueData.labels.shift();
      revenueData.datasets[0].data.push(metrics.revenue);
      revenueData.datasets[0].data.shift();
      revenueChart.update();

      // users chart
      usersData.labels.push(nowLabel);
      usersData.labels.shift();
      usersData.datasets[0].data.push(metrics.users);
      usersData.datasets[0].data.shift();
      usersChart.update();
    }

    // initial render pass to ensure UI reflects initial state
    document.addEventListener('DOMContentLoaded', () => {
      // display initial values
      document.getElementById('metric-revenue').textContent = formatCurrency(metrics.revenue);
      document.getElementById('metric-users').textContent = formatNumber(metrics.users);
      document.getElementById('metric-listings').textContent = formatNumber(metrics.listings);
      document.getElementById('metric-flags').textContent = formatNumber(metrics.flags);
    });

    // start the periodic updater
    updateMetricsAndCharts(); // first immediate update
    setInterval(updateMetricsAndCharts, REFRESH_MS);

    // expose for debugging in console
    window.__zzz_metrics = metrics;
    window.__zzz_updateMetricsAndCharts = updateMetricsAndCharts;

  </script>
</body>
</html>
