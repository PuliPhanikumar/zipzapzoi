<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>ZipZapZoi - Listing Details</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#019863",
            "secondary": "#4D96A9",
            "background-light": "#F7F9FC",
            "background-dark": "#1A202C",
            "text-light": "#333333",
            "text-dark": "#E2E8F0",
            "accent": "#FFD166",
          },
          fontFamily: { "display": ["Spline Sans", "sans-serif"] },
          borderRadius: { "DEFAULT": "12px", "xl": "24px" },
          boxShadow: { 'bouncy': '0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07)' }
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
  </style>
  <script src="js/data-manager.js"></script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark antialiased">

  <header class="w-full bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-secondary text-3xl">all_inclusive</span>
        <h2 class="text-xl font-bold">ZipZapZoi</h2>
      </div>
      <a href="classifieds.html" class="flex items-center gap-1 text-sm font-semibold hover:text-primary transition-colors">
        <span class="material-symbols-outlined text-lg">arrow_back</span> Back to Browse
      </a>
    </div>
  </header>

  <main class="w-full max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <div class="flex flex-wrap gap-2 px-1 pb-6 text-sm">
      <a class="text-gray-500 hover:text-primary" href="classifieds.html">Home</a>
      <span class="text-gray-400">/</span>
      <a class="text-gray-500 hover:text-primary" href="classifieds.html" id="breadCategoryLink">Categories</a>
      <span class="text-gray-400">/</span>
      <span class="text-primary font-bold" id="breadTitle">Details</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
      
      <div class="lg:col-span-3 flex flex-col gap-8">
        
        <div id="gallery" class="relative rounded-2xl shadow-bouncy overflow-hidden group bg-gray-100 dark:bg-gray-700 aspect-video">
          <div id="galleryMain" class="w-full h-full bg-center bg-no-repeat bg-contain transition-all duration-300"></div>
          
          <button id="galleryPrev" class="absolute top-1/2 left-4 -translate-y-1/2 bg-white/80 dark:bg-black/50 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all hover:scale-110">
            <span class="material-symbols-outlined">arrow_back_ios_new</span>
          </button>
          <button id="galleryNext" class="absolute top-1/2 right-4 -translate-y-1/2 bg-white/80 dark:bg-black/50 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all hover:scale-110">
            <span class="material-symbols-outlined">arrow_forward_ios</span>
          </button>
          
          <div id="galleryDots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2"></div>
        </div>

        <div id="galleryThumbnails" class="flex gap-3 overflow-x-auto pb-2 hidden"></div>

        <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-bouncy">
          <h3 class="text-xl font-bold mb-4 border-b border-gray-100 dark:border-gray-700 pb-2">Description</h3>
          <p id="listingDescription" class="text-gray-600 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">Loading description...</p>
        </div>

      </div>

      <div class="lg:col-span-2 flex flex-col gap-6">
        
        <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-bouncy flex flex-col gap-4 border-t-4 border-primary">
          <div>
             <span id="listingCategoryBadge" class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-700 text-xs font-bold uppercase tracking-wider text-gray-500 rounded-full mb-2">Category</span>
             <h1 id="listingTitle" class="text-2xl font-bold leading-tight">Loading Title...</h1>
          </div>
          
          <div class="text-4xl font-bold text-primary tracking-tight" id="listingPrice">--</div>
          
          <div id="attributesGrid" class="grid grid-cols-2 gap-3 py-4 border-t border-b border-gray-100 dark:border-gray-700">
             </div>

          <div class="flex items-center gap-2 text-sm text-gray-500">
            <span class="material-symbols-outlined text-lg">location_on</span>
            <span id="listingLocation">Loading location...</span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-500">
            <span class="material-symbols-outlined text-lg">schedule</span>
            <span id="listingTime">Posted recently</span>
          </div>

          <div class="flex gap-3 pt-2">
            <button onclick="openMessageModal()" class="flex-1 bg-secondary hover:bg-primary text-white h-12 rounded-xl font-bold shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2">
              <span class="material-symbols-outlined">chat</span> Chat
            </button>
            <button onclick="callSeller()" class="flex-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-text-light dark:text-text-dark h-12 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
              <span class="material-symbols-outlined">call</span> Call
            </button>
          </div>
        </div>

        <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-bouncy flex items-center gap-4">
          <div class="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-white text-xl font-bold" id="sellerAvatar">S</div>
          <div class="flex-1">
            <p id="sellerName" class="font-bold text-lg">Seller Name</p>
            <div class="flex items-center gap-1 text-sm text-gray-500">
              <span class="material-symbols-outlined text-yellow-500 text-sm">star</span>
              <span>4.8 (Verified)</span>
            </div>
          </div>
          <button class="text-sm font-bold text-secondary hover:underline">View Profile</button>
        </div>

        <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-bouncy">
          <h3 class="font-bold text-sm text-gray-500 mb-3">Location Map</h3>
          <div class="w-full h-40 bg-gray-200 dark:bg-gray-700 rounded-xl flex items-center justify-center">
            <div class="text-center text-gray-400">
               <span class="material-symbols-outlined text-3xl">map</span>
               <p class="text-xs mt-1">Map View</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="mt-12">
      <h2 class="text-2xl font-bold mb-6">You Might Also Like</h2>
      <div id="similarGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
         </div>
    </div>

  </main>

  <div id="messageModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
      <div class="bg-secondary p-4 flex justify-between items-center text-white">
        <h3 class="font-bold text-lg">Contact Seller</h3>
        <button onclick="closeMessageModal()" class="material-symbols-outlined hover:bg-white/20 rounded-full p-1">close</button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Subject</label>
          <input type="text" id="msgSubject" class="w-full bg-gray-50 dark:bg-gray-700 border-none rounded-lg text-sm" readonly>
        </div>
        <div>
           <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Your Message</label>
           <textarea id="msgText" rows="4" class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg focus:ring-secondary" placeholder="Hi, is this still available?"></textarea>
        </div>
        <button onclick="sendMessage()" class="w-full bg-primary hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">Send Message</button>
      </div>
    </div>
  </div>

  <script src="scripts/auth.js"></script>
  <script src="scripts/boot.js"></script>
  <script>
  (function() {
    // --- 1. DATA SOURCES (Must match Classifieds.html) ---
    const mockListings = [
        { id: '101', title: "iPhone 14 Pro - Deep Purple", category: "Electronics", price: "65000", location: "Indiranagar, Bengaluru", time: "2 hrs ago", image: "https://images.unsplash.com/photo-1695048133142-1a20484d2569?auto=format&fit=crop&w=600&q=80", desc: "Pristine condition iPhone 14 Pro. Battery health 98%. Comes with box and cable.", brand: "Apple", condition: "Used - Like New" },
        { id: '102', title: "Royal Enfield Classic 350", category: "Vehicles", price: "145000", location: "Bandra, Mumbai", time: "5 hrs ago", image: "https://images.unsplash.com/photo-1558981403-c5f9899a28bc?auto=format&fit=crop&w=600&q=80", desc: "Single owner, well maintained. Insurance valid till 2025.", brand: "Royal Enfield", year: "2021", km_driven: "12000" },
        { id: '103', title: "2 BHK Apartment for Rent", category: "Real Estate", price: "25000", location: "Gachibowli, Hyderabad", time: "Yesterday", image: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=600&q=80", desc: "Spacious semi-furnished flat in gated community.", area: "1200 sqft", furnishing: "Semi-Furnished" },
        { id: '104', title: "Graphic Designer (Remote)", category: "Jobs", price: "45000", location: "Remote", time: "1 day ago", image: "https://images.unsplash.com/photo-1626785774573-4b799314346d?auto=format&fit=crop&w=600&q=80", desc: "Looking for senior designer with 3+ years exp.", role: "Senior Designer", exp: "3 Years" },
        { id: '105', title: "Golden Retriever Puppies", category: "Pets", price: "15000", location: "Vasant Vihar, Delhi", time: "3 days ago", image: "https://images.unsplash.com/photo-1629740032638-58bfd37eb74e?auto=format&fit=crop&w=600&q=80", desc: "KCI Registered puppies. Vaccinated.", breed: "Golden Retriever", age: "2 Months" }
    ];

    // Helper: Get listing from either LocalStorage (User posts) or Mock Data
    function getListingById(id) {
        const userPosts = JSON.parse(localStorage.getItem('zzz_listings') || '[]');
        // Check User Posts first
        const foundUser = userPosts.find(p => p.id == id);
        if (foundUser) return { ...foundUser, isUserPost: true };

        // Check Mock Data
        const foundMock = mockListings.find(p => p.id == id);
        if (foundMock) return foundMock;

        return null;
    }

    // --- 2. MAIN LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) {
           alert("No Listing ID provided.");
           window.location.href = 'classifieds.html';
           return;
        }

        const listing = getListingById(id);

        if (!listing) {
           document.body.innerHTML = `<div class="flex flex-col items-center justify-center min-h-screen"><h2 class="text-2xl font-bold mb-4">Listing Not Found</h2><a href="classifieds.html" class="text-primary hover:underline">Back to Classifieds</a></div>`;
           return;
        }

        // --- POPULATE UI ---
        document.title = `${listing.title} - ZipZapZoi`;
        
        // Text Content
        document.getElementById('listingTitle').textContent = listing.title;
        document.getElementById('listingPrice').textContent = listing.category === 'Charity' ? 'Free' : `₹ ${listing.price}`;
        document.getElementById('listingLocation').textContent = listing.location || `${listing.city}, ${listing.state}`;
        document.getElementById('listingTime').textContent = listing.time || 'Just now';
        document.getElementById('listingDescription').textContent = listing.description || listing.desc || "No description provided.";
        document.getElementById('listingCategoryBadge').textContent = listing.category;
        document.getElementById('breadCategoryLink').textContent = listing.category;
        document.getElementById('breadTitle').textContent = listing.title.substring(0, 20) + '...';
        
        // Seller
        document.getElementById('sellerName').textContent = listing.sellerName || "ZipZapZoi User";
        document.getElementById('sellerAvatar').textContent = (listing.sellerName || "U").charAt(0).toUpperCase();

        // --- DYNAMIC ATTRIBUTES (The "Meta" Grid) ---
        const attributesGrid = document.getElementById('attributesGrid');
        attributesGrid.innerHTML = '';
        
        // Helper to add attribute
        const addAttr = (label, value) => {
            if (value) {
                attributesGrid.innerHTML += `
                    <div class="flex flex-col bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <span class="text-xs text-gray-500 uppercase">${label}</span>
                        <span class="font-bold text-sm truncate">${value}</span>
                    </div>`;
            }
        };

        // Add standard attributes if they exist in the object
        addAttr('Condition', listing.condition);
        addAttr('Brand', listing.brand);
        addAttr('Year', listing.year);
        addAttr('Fuel', listing.fuel);
        addAttr('KM Driven', listing.km_driven);
        addAttr('Area', listing.area);
        addAttr('Furnishing', listing.furnishing);
        addAttr('Role', listing.role);
        addAttr('Experience', listing.exp);
        addAttr('Breed', listing.breed);
        
        // --- IMAGE GALLERY LOGIC ---
        let images = [];
        if (listing.images && listing.images.length > 0) {
            images = listing.images;
        } else if (listing.image) {
            images = [listing.image];
        } else {
            // Category placeholder fallback
            images = ['https://via.placeholder.com/800x600?text=No+Image+Available'];
        }

        const galleryMain = document.getElementById('galleryMain');
        const galleryDots = document.getElementById('galleryDots');
        let currentImgIdx = 0;

        function updateGallery(idx) {
            currentImgIdx = idx;
            galleryMain.style.backgroundImage = `url('${images[idx]}')`;
            // Update dots
            galleryDots.innerHTML = images.map((_, i) => 
                `<div class="w-2 h-2 rounded-full transition-all cursor-pointer ${i === idx ? 'bg-white scale-125' : 'bg-white/50 hover:bg-white/80'}" onclick="window.setGallery(${i})"></div>`
            ).join('');
        }

        // Export for onclick
        window.setGallery = updateGallery;

        // Init Gallery
        updateGallery(0);

        // Arrows
        document.getElementById('galleryNext').onclick = () => updateGallery((currentImgIdx + 1) % images.length);
        document.getElementById('galleryPrev').onclick = () => updateGallery((currentImgIdx - 1 + images.length) % images.length);

        // Thumbnails (if > 1 image)
        if (images.length > 1) {
            const thumbs = document.getElementById('galleryThumbnails');
            thumbs.classList.remove('hidden');
            images.forEach((img, i) => {
                const d = document.createElement('div');
                d.className = "min-w-[80px] h-16 rounded-lg bg-cover bg-center cursor-pointer border-2 border-transparent hover:border-primary transition-all";
                d.style.backgroundImage = `url('${img}')`;
                d.onclick = () => updateGallery(i);
                thumbs.appendChild(d);
            });
        }

        // --- SIMILAR LISTINGS (Mock) ---
        const similarGrid = document.getElementById('similarGrid');
        const similar = mockListings.filter(l => l.category === listing.category && l.id != listing.id).slice(0, 4);
        
        if (similar.length > 0) {
            similar.forEach(item => {
                similarGrid.innerHTML += `
                <a href="Listing Detail.html?id=${item.id}" class="group block bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-lg transition-all overflow-hidden">
                    <div class="h-40 bg-cover bg-center" style="background-image: url('${item.image}')"></div>
                    <div class="p-3">
                        <h4 class="font-bold truncate group-hover:text-primary">${item.title}</h4>
                        <p class="text-primary font-bold">₹ ${item.price}</p>
                    </div>
                </a>`;
            });
        } else {
            document.querySelector('.mt-12').classList.add('hidden'); // Hide if no similar
        }

        // --- PREPARE MESSAGE MODAL ---
        document.getElementById('msgSubject').value = `Re: ${listing.title}`;
    });

    // --- GLOBAL ACTIONS ---
    window.openMessageModal = () => {
        document.getElementById('messageModal').classList.remove('hidden');
    };
    
    window.closeMessageModal = () => {
        document.getElementById('messageModal').classList.add('hidden');
    };

    window.sendMessage = () => {
        const text = document.getElementById('msgText').value;
        if(!text) return alert("Please type a message.");
        
        // Here you would save to localStorage 'zzz_messages'
        alert("Message Sent! (Simulated)");
        closeMessageModal();
    };

    window.callSeller = () => {
        alert("Calling Seller: +91 98XXX XXXXX (Simulated)");
    };

  })();
  </script>
</body>
</html>