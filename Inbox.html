<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  // --- AUTH CHECK ---
  (function() {
    const raw = localStorage.getItem('zzz_user');
    if (!raw) {
      window.location.href = 'Login Page.html';
    }
  })();
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZipZapZoi - Messages</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Spline Sans", "sans-serif"] },
          colors: {
            "primary": "#019863",
            "secondary": "#4D96A9",
            "bg-chat": "#E5DDD5",
            "bubble-me": "#DCF8C6",
            "bubble-them": "#FFFFFF",
          },
          boxShadow: {
            "bouncy": "0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05)",
          }
        }
      }
    }
  </script>
  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    
    /* Scrollbar Styling */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .msg-bubble { max-width: 85%; word-wrap: break-word; }
    .msg-time { font-size: 10px; opacity: 0.7; margin-top: 2px; text-align: right; }
    
    .slide-in { animation: slideIn 0.2s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800">

  <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 z-10 flex-shrink-0">
    <div class="flex items-center gap-3">
      <a href="classifieds.html" class="text-primary hover:text-green-700 transition-colors">
        <span class="material-symbols-outlined text-3xl">all_inclusive</span>
      </a>
      <h1 class="font-bold text-xl tracking-tight text-gray-800">Messages</h1>
    </div>
    <div class="flex items-center gap-4">
      <a href="Seller Dashboard.html" class="hidden md:flex items-center gap-2 text-sm font-bold text-gray-600 hover:text-primary transition-colors">
        <span class="material-symbols-outlined text-lg">dashboard</span> Dashboard
      </a>
      <div class="h-9 w-9 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md border-2 border-white" id="userAvatar">U</div>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden">
    
    <aside class="w-full md:w-80 lg:w-96 bg-white border-r border-gray-200 flex flex-col z-20 md:flex" id="sidebar">
      <div class="p-4 border-b border-gray-100">
        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400 text-lg">search</span>
          <input type="text" id="searchBox" placeholder="Search chats..." class="w-full bg-gray-50 border border-gray-200 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all">
        </div>
      </div>

      <div class="flex-1 overflow-y-auto custom-scroll" id="conversationList">
        </div>
    </aside>

    <main class="flex-1 flex-col bg-[#efeae2] relative hidden md:flex" id="chatArea">
      
      <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-gray-50 z-0">
        <div class="w-40 h-40 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-500">
           <span class="material-symbols-outlined text-7xl">chat</span>
        </div>
        <h2 class="text-2xl font-bold text-gray-700 mb-2">Select a Conversation</h2>
        <p class="text-gray-500 max-w-sm">Choose a chat from the left to view messages or negotiate prices.</p>
      </div>

      <div id="activeChat" class="flex flex-col h-full hidden z-10 w-full bg-[#efeae2]">
        
        <div class="bg-white px-4 py-3 border-b border-gray-200 flex items-center justify-between shadow-sm">
          <div class="flex items-center gap-3">
            <button class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full" onclick="closeChatMobile()">
              <span class="material-symbols-outlined">arrow_back</span>
            </button>
            
            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold text-lg" id="chatAvatar">?</div>
            <div>
              <h3 class="font-bold text-gray-800 leading-tight" id="chatName">User Name</h3>
              <p class="text-xs text-green-600 font-medium flex items-center gap-1" id="typingIndicator">
                <span class="w-2 h-2 rounded-full bg-green-500"></span> Online
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
             <button class="hidden md:flex p-2 text-gray-400 hover:text-red-500 rounded-full hover:bg-gray-100" onclick="closeChatDesktop()" title="Close Chat">
               <span class="material-symbols-outlined">close</span>
             </button>
             <button class="md:hidden text-gray-400"><span class="material-symbols-outlined">more_vert</span></button>
          </div>
        </div>

        <div class="bg-white/95 backdrop-blur-sm px-4 py-2 border-b border-gray-200 flex items-center justify-between text-sm shadow-sm z-10" id="contextBanner">
           <div class="flex items-center gap-3 overflow-hidden">
             <div class="w-10 h-10 bg-gray-100 rounded bg-cover bg-center flex-shrink-0" id="contextImg" style="background-image: url('https://via.placeholder.com/150');"></div>
             <div class="min-w-0">
               <p class="font-bold text-gray-800 truncate" id="contextTitle">Listing Title</p>
               <p class="text-primary font-bold text-xs" id="contextPrice">₹ 0</p>
             </div>
           </div>
           <a href="#" id="contextLink" class="text-xs font-bold text-blue-600 hover:underline bg-blue-50 px-3 py-1 rounded-full whitespace-nowrap">View Ad</a>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scroll" id="messagesFeed" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay;">
           </div>

        <div class="px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar bg-[#efeae2]/50" id="quickReplies">
           <button class="bg-white border border-gray-200 rounded-full px-3 py-1 text-xs font-medium text-gray-600 hover:bg-gray-50 hover:text-primary shadow-sm whitespace-nowrap transition-colors" onclick="setInput('Is this still available?')">Is this available?</button>
           <button class="bg-white border border-gray-200 rounded-full px-3 py-1 text-xs font-medium text-gray-600 hover:bg-gray-50 hover:text-primary shadow-sm whitespace-nowrap transition-colors" onclick="setInput('What is your best price?')">Best price?</button>
           <button class="bg-white border border-gray-200 rounded-full px-3 py-1 text-xs font-medium text-gray-600 hover:bg-gray-50 hover:text-primary shadow-sm whitespace-nowrap transition-colors" onclick="setInput('Yes, it is available!')">Yes, available!</button>
        </div>

        <div class="bg-white p-3 border-t border-gray-200 flex items-center gap-2">
          <button class="p-2 text-gray-400 hover:text-primary rounded-full hover:bg-gray-100 transition-colors"><span class="material-symbols-outlined">add_circle</span></button>
          <input type="text" id="msgInput" class="flex-1 bg-gray-100 border-none rounded-full px-4 py-2.5 focus:ring-2 focus:ring-primary/50 outline-none transition-all placeholder-gray-400" placeholder="Type a message...">
          <button onclick="sendMessage()" class="p-2.5 bg-primary text-white rounded-full shadow-lg hover:bg-green-700 transition-transform active:scale-95 flex items-center justify-center">
            <span class="material-symbols-outlined text-lg">send</span>
          </button>
        </div>

      </div>
    </main>
  </div>

  <script>
    const currentUser = JSON.parse(localStorage.getItem('zzz_user'));
    const STORAGE_KEY = 'zzz_messages';
    
    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();

    // --- 1. DATA SEEDING (Auto-fill if empty) ---
    function seedData() {
      let allMsgs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if(allMsgs.length > 0) return; 

      const now = Date.now();
      const samples = [
        {
          id: 'msg_1', fromUserId: 'user_bob', fromName: 'Bob Builder', toUserId: currentUser.id, toName: currentUser.name,
          listingId: '101', listingTitle: 'iPhone 14 Pro - Deep Purple', text: 'Hi, is the price negotiable?', timestamp: new Date(now - 86400000).toISOString(), read: false
        },
        {
          id: 'msg_2', fromUserId: 'user_alice', fromName: 'Alice Wonderland', toUserId: currentUser.id, toName: currentUser.name,
          listingId: '102', listingTitle: 'Royal Enfield Classic 350', text: 'Can I come see the bike tomorrow?', timestamp: new Date(now - 3600000).toISOString(), read: false
        }
      ];
      localStorage.setItem(STORAGE_KEY, JSON.stringify(samples));
    }

    // --- 2. LOAD CONVERSATIONS ---
    function getConversations() {
      seedData();
      const allMsgs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const convMap = {};

      allMsgs.forEach(msg => {
        const participants = [msg.fromUserId, msg.toUserId].sort().join('_');
        const convId = `${participants}_${msg.listingId}`;

        if (!convMap[convId]) {
          convMap[convId] = {
            id: convId,
            listingId: msg.listingId,
            listingTitle: msg.listingTitle,
            otherUser: msg.fromUserId === currentUser.id ? msg.toName : msg.fromName,
            lastMsg: msg,
            unreadCount: 0
          };
        }
        
        if (new Date(msg.timestamp) > new Date(convMap[convId].lastMsg.timestamp)) {
          convMap[convId].lastMsg = msg;
        }
        
        if(msg.toUserId === currentUser.id && !msg.read) {
           convMap[convId].unreadCount++;
        }
      });

      return Object.values(convMap).sort((a, b) => new Date(b.lastMsg.timestamp) - new Date(a.lastMsg.timestamp));
    }

    let activeConvId = null;

    function renderList() {
      const list = getConversations();
      const container = document.getElementById('conversationList');
      const search = document.getElementById('searchBox').value.toLowerCase();

      if (list.length === 0) {
        container.innerHTML = `<div class="p-8 text-center text-gray-400"><p>No messages yet.</p></div>`;
        return;
      }

      container.innerHTML = list
        .filter(c => c.listingTitle.toLowerCase().includes(search) || (c.lastMsg.text && c.lastMsg.text.toLowerCase().includes(search)))
        .map(c => {
          const isActive = c.id === activeConvId;
          const date = new Date(c.lastMsg.timestamp).toLocaleDateString([], {month:'short', day:'numeric'});
          
          return `
          <div onclick="openChat('${c.id}')" class="flex gap-3 p-4 cursor-pointer hover:bg-gray-50 border-b border-gray-100 transition-colors ${isActive ? 'bg-blue-50 border-l-4 border-l-primary' : 'border-l-4 border-l-transparent'}">
            <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0 flex items-center justify-center font-bold text-gray-500">${c.otherUser ? c.otherUser.charAt(0) : '?'}</div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-baseline mb-1">
                <h4 class="font-bold text-gray-800 truncate text-sm">${c.otherUser || 'User'}</h4>
                <span class="text-xs text-gray-400 whitespace-nowrap">${date}</span>
              </div>
              <p class="text-xs text-gray-500 truncate mb-1">${c.listingTitle}</p>
              <div class="flex justify-between items-center">
                 <p class="text-sm text-gray-600 truncate ${c.unreadCount > 0 ?'font-bold text-gray-900':''}">${c.lastMsg.text}</p>
                 ${c.unreadCount > 0 ? `<span class="bg-primary text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full ml-2">${c.unreadCount}</span>` : ''}
              </div>
            </div>
          </div>
          `;
        }).join('');
    }

    // --- 3. OPEN CHAT ---
    function openChat(convId) {
      activeConvId = convId;
      
      const allMsgs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let updated = false;
      const parts = convId.split('_'); 
      const listingId = parts[2]; 

      const msgs = allMsgs.filter(m => {
         const p = [m.fromUserId, m.toUserId].sort().join('_');
         const isMatch = `${p}_${m.listingId}` === convId;
         if(isMatch && m.toUserId === currentUser.id && !m.read) {
             m.read = true; updated = true;
         }
         return isMatch;
      }).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

      if(updated) { localStorage.setItem(STORAGE_KEY, JSON.stringify(allMsgs)); renderList(); }
      
      // UI Updates (Responsive Handling)
      document.getElementById('emptyState').classList.add('hidden'); // Always hide empty state when chatting
      document.getElementById('chatArea').classList.remove('hidden'); // Ensure right col is visible
      document.getElementById('activeChat').classList.remove('hidden'); // Show chat UI
      
      // On Mobile (< 768px), hide the sidebar
      if(window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('hidden');
      }

      const otherName = msgs[0].fromUserId === currentUser.id ? msgs[0].toName : msgs[0].fromName;
      document.getElementById('chatName').textContent = otherName || 'User';
      document.getElementById('chatAvatar').textContent = (otherName || '?').charAt(0);
      document.getElementById('contextTitle').textContent = msgs[0].listingTitle;
      document.getElementById('contextLink').href = `Listing Detail.html?id=${listingId}`;

      const feed = document.getElementById('messagesFeed');
      feed.innerHTML = msgs.map(m => {
        const isMe = m.fromUserId === currentUser.id;
        return `
          <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} slide-in">
            <div class="msg-bubble px-4 py-2 rounded-xl shadow-sm relative text-sm ${isMe ? 'bg-bubble-me text-gray-800 rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none'}">
              ${m.text}
              <div class="msg-time ${isMe ? 'text-green-100' : 'text-gray-400'}">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} 
              ${isMe ? '<span class="material-symbols-outlined text-[10px] text-blue-500 align-middle ml-1">done_all</span>' : ''}</div>
            </div>
          </div>
        `;
      }).join('');
      
      feed.scrollTop = feed.scrollHeight;
    }

    // --- 4. SEND MESSAGE & AUTO-REPLY ---
    function sendMessage() {
      const txt = document.getElementById('msgInput').value.trim();
      if(!txt || !activeConvId) return;

      const allMsgs = JSON.parse(localStorage.getItem(STORAGE_KEY));
      const parts = activeConvId.split('_');
      const otherUserId = parts[0] === currentUser.id ? parts[1] : parts[0]; 
      
      const refMsg = allMsgs.find(m => {
         const p = [m.fromUserId, m.toUserId].sort().join('_');
         return `${p}_${m.listingId}` === activeConvId;
      });
      const otherName = refMsg ? (refMsg.fromUserId === currentUser.id ? refMsg.toName : refMsg.fromName) : 'User';

      const newMsg = {
        id: 'msg_' + Date.now(),
        fromUserId: currentUser.id,
        fromName: currentUser.name,
        toUserId: otherUserId,
        toName: otherName,
        listingId: refMsg.listingId,
        listingTitle: refMsg.listingTitle,
        text: txt,
        timestamp: new Date().toISOString(),
        read: false
      };

      allMsgs.push(newMsg);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allMsgs));
      
      document.getElementById('msgInput').value = '';
      openChat(activeConvId); // Refresh Chat UI instantly
      renderList(); // Update Sidebar Snippet
      
      // TRIGGER SIMULATED REPLY
      document.getElementById('typingIndicator').innerHTML = '<span class="animate-pulse text-primary">typing...</span>';
      
      setTimeout(() => {
         simulateReply(activeConvId, otherUserId, otherName, refMsg.listingId, refMsg.listingTitle);
      }, 2000);
    }

    function simulateReply(convId, userId, userName, listId, listTitle) {
      const replies = ["Yes, it is available!", "Can you send more pics?", "I can offer ₹500 less.", "When can I come see it?", "Let's meet tomorrow.", "Okay, sounds good."];
      const randomText = replies[Math.floor(Math.random() * replies.length)];

      const replyMsg = {
        id: 'msg_' + Date.now(),
        fromUserId: userId,
        fromName: userName,
        toUserId: currentUser.id,
        toName: currentUser.name,
        listingId: listId,
        listingTitle: listTitle,
        text: randomText,
        timestamp: new Date().toISOString(),
        read: false
      };

      const allMsgs = JSON.parse(localStorage.getItem(STORAGE_KEY));
      allMsgs.push(replyMsg);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allMsgs));

      // If user is currently looking at THIS chat, refresh it
      if (activeConvId === convId) {
        document.getElementById('typingIndicator').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
        openChat(convId);
      }
      renderList(); // Update badge
    }

    function setInput(text) {
      document.getElementById('msgInput').value = text;
      document.getElementById('msgInput').focus();
    }

    // --- 5. RESPONSIVE HELPERS ---
    
    // CLOSE CHAT (Mobile): Go back to list
    function closeChatMobile() {
      document.getElementById('activeChat').classList.add('hidden');
      document.getElementById('sidebar').classList.remove('hidden'); // Show List
      activeConvId = null;
      renderList(); // Clear active styling
    }

    // CLOSE CHAT (Desktop): Show Empty State
    function closeChatDesktop() {
      document.getElementById('activeChat').classList.add('hidden');
      document.getElementById('emptyState').classList.remove('hidden'); // Show "Select a Conversation"
      activeConvId = null;
      renderList(); // Clear active styling
    }

    document.getElementById('msgInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') sendMessage();
    });

    document.getElementById('searchBox').addEventListener('input', renderList);

    // Initial Load
    renderList();

  </script>
</body>
</html>