/* =========================================================
   ZipZapZoi Universal Auth System â€” auth.js
   ---------------------------------------------------------
   Handles: 
   - Global Nav Auth UI
   - Login persistence across pages
   - User personalization
   - Auth-required actions
   ========================================================= */

(function(){
  const STORAGE_KEY = "zzz_user";
  const navArea = document.getElementById("navAuthArea");

  // Helper: safely get logged-in user
  function getUser(){
    try {
      return JSON.parse(sessionStorage.getItem(STORAGE_KEY) || localStorage.getItem(STORAGE_KEY) || "null");
    } catch(e){
      console.warn("Auth parse error", e);
      return null;
    }
  }

  // Helper: save user to both storages for persistence
  function setUser(user){
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(user));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
  }

  // Helper: clear user
  function logoutUser(){
    sessionStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  // Helper: guard for protected actions
  window.requireLogin = function(action){
    const user = getUser();
    if(!user){
      alert("Please log in or sign up to continue.");
      location.href = "Login Page.html";
      return false;
    }
    return true;
  }

  // Render global nav bar if placeholder exists
  if(navArea){
    const user = getUser();
    if(user){
      navArea.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="bg-primary/10 rounded-full w-10 h-10 flex items-center justify-center text-primary font-bold uppercase shadow-bouncy">
            ${user.email.charAt(0).toUpperCase()}
          </div>
          <div class="flex flex-col leading-tight">
            <p class="font-semibold text-dark-charcoal dark:text-white">${user.email.split('@')[0]}</p>
            <button id="logoutBtn" class="text-sm text-red-500 font-medium hover:underline">Logout</button>
          </div>
        </div>
      `;
      document.getElementById("logoutBtn").addEventListener("click", logoutUser);

      // Optional personalization: update greeting if present
      const title = document.getElementById("welcomeTitle");
      if(title) title.textContent = `Welcome back, ${user.email.split('@')[0]}!`;

    } else {
      navArea.innerHTML = `
        <a href="Login Page.html" class="px-4 py-2 text-sm font-semibold text-dark-charcoal dark:text-white hover:text-primary transition-colors">Log In</a>
        <a href="User Registration.html" class="px-5 py-2 bg-primary text-white rounded-full font-bold shadow-bouncy hover:-translate-y-0.5 hover:shadow-bouncy-lg transition-all">Sign Up</a>
      `;
      const title = document.getElementById("welcomeTitle");
      if(title) title.textContent = "Welcome to ZipZapZoi!";
    }
  }

  // Auto-login continuity across reloads
  // (If only in localStorage, restore to sessionStorage)
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved && !sessionStorage.getItem(STORAGE_KEY)){
    sessionStorage.setItem(STORAGE_KEY, saved);
  }

  // Export helpers globally (optional)
  window.ZipZapAuth = { getUser, setUser, logoutUser };
})();
